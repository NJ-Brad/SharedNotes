# Local Cloud (FOG)

## Included projects
SampleServer
CentralConfig
Blueprint.Proxy
ServerManager
SwaggerCentral


Organizer


## Swagger UI for microservices
"Swag Bag"

There will be TWO swagger collections.  One for FOG and one for the actual application.

Leverages the ability to set up OpenAPI in .Net microservices, at the click of a button.

Consolidates each microservice into a single point of reference.

Does not expose individual microservices to external users
More secure
Only one configuration for reverse proxy

### Considerations
+ Need to consider using categories
+ Do I put all information into a "sorted document", or pull each category at the end, sort it, then put it back?
+ could also tag the items to match the server they come from.  [
	Grouping Operations With Tags
](https://swagger.io/docs/specification/grouping-operations-with-tags/ "
	Grouping Operations With Tags
")
Functional parts of Fog-LC should be written as components that can also be launched directly from the command line.  This will allow the components to be used outside of the main project

## Links
[Benefits of using the OpenAPI (Swagger) specification for your API? | Moesif Blog](https://www.moesif.com/blog/technical/api-design/Benefits-of-using-the-OpenAPI-Swagger-specification-for-your-API/ "Benefits of using the OpenAPI (Swagger) specification for your API? | Moesif Blog")
[https://github.com/microsoft/OpenAPI.NET](https://github.com/microsoft/OpenAPI.NET "https://github.com/microsoft/OpenAPI.NET")
[https://github.com/andreytreyt/yarp-swagger](https://github.com/andreytreyt/yarp-swagger "https://github.com/andreytreyt/yarp-swagger")
[Configuring and Using Swagger UI in ASP.NET Core Web API - Code Maze](https://code-maze.com/swagger-ui-asp-net-core-web-api/ "Configuring and Using Swagger UI in ASP.NET Core Web API - Code Maze")
[Paths and Operations
](https://swagger.io/docs/specification/paths-and-operations/ "Paths and Operations")

Lots of interesting pieces here : [Configuring and Using Swagger UI in ASP.NET Core Web API - Code Maze](https://code-maze.com/swagger-ui-asp-net-core-web-api/ "Configuring and Using Swagger UI in ASP.NET Core Web API - Code Maze")


// https://learn.microsoft.com/en-us/aspnet/core/tutorials/web-api-help-pages-using-swagger?view=aspnetcore-8.0#securing-swagger-ui-endpoints
// https://www.daveabrock.com/2020/11/16/httprepl-openapi-swagger-netcoreapis/
// customizing UI : https://halldorstefans.com/how-i-customized-the-swagger-ui-in-asp-net-core/


// https://dejanstojanovic.net/aspnet/2020/april/combining-multiple-swagger-api-endpoints-in-a-single-ui/

// https://stackoverflow.com/questions/54460863/c-sharp-swagger-documentation-for-individual-members-of-the-request-body-object
// https://stackoverflow.com/questions/54460863/c-sharp-swagger-documentation-for-individual-members-of-the-request-body-object



### HTTP-Repl
[https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/web-api/http-repl/index.md](https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/web-api/http-repl/index.md "https://github.com/dotnet/AspNetCore.Docs/blob/main/aspnetcore/web-api/http-repl/index.md")
[Test web APIs with the HttpRepl | Microsoft Learn](https://learn.microsoft.com/en-us/aspnet/core/web-api/http-repl/?view=aspnetcore-8.0&tabs=linux "Test web APIs with the HttpRepl | Microsoft Learn")
[https://github.com/dotnet/HttpRepl](https://github.com/dotnet/HttpRepl "https://github.com/dotnet/HttpRepl")
[How to use HttpRepl to navigate API endpoints](https://www.code4it.dev/blog/httprepl/ "How to use HttpRepl to navigate API endpoints &vert; Code4IT")

## Steps to create
New project ASP.NET Core Web API
Name the project SwagBag
Make sure "Enable OpenAPI support" is checked
Compile and execute the project.  You should see the Swagger UI
![20240417-104607.jpg](<$LOCATION$>20240417-104607.jpg)
Add package Microsoft.OpenApi.Readers

Modify Program.cs
Replace
```csharp
app.UseSwaggerUI();
```
with
```csharp
app.UseSwaggerUI(c =>
{
    // this is the original one - might remove it later
    c.SwaggerEndpoint("/swagger/v1/swagger.json", "Swag Bag (local)");

    var crp = builder.Environment.ContentRootPath;

    c.AddSwaggers(app.Configuration, crp);
});
```
Before ```app.run();```
Add
```csharp
app.MapGet("/dl/v1/combined.json", async () =>
{
    string fileName = Path.Join(app.Environment.ContentRootPath, "/dl/v1/combined.json");

    Stream stream = File.OpenRead(fileName);

    if (stream == null)
    {
        TypedResults.NotFound();
    }

    return Results.Stream(stream, "application/json");
});
```
Add a file to the project, named OpenApiDocumentExtensions.cs
```csharp
using Microsoft.OpenApi;
using Microsoft.OpenApi.Extensions;
using Microsoft.OpenApi.Interfaces;
using Microsoft.OpenApi.Models;
using Microsoft.OpenApi.Readers;
using Swashbuckle.AspNetCore.SwaggerUI;

namespace OpenApiExtensions
{
    public static class OpenApiDocumentExtensions
    {
        public static void AddSwaggers(this SwaggerUIOptions c, IConfiguration config, string contentRoot, string folderPath = "/dl/v1/")
        {
            if (config == null)
            {
                throw new ArgumentNullException("config");
            }

            IConfiguration config2 = config.GetSection("Swaggers");
            if (config2 == null)
            {
                throw new ArgumentNullException("Swaggers section missing from config (appsettings.json)");
            }

            List<SwaggerEntry>? list = config2.Get<List<SwaggerEntry>>();

            OpenApiDocument combinedDoc = new();
            combinedDoc.Paths = new();
            combinedDoc.Components = new();

            //SortedDictionary<string, OpenApiPathItem> paths = new();

            foreach (SwaggerEntry se in list)
            {
                // Get file and store it somewhere

                ;

                // https://visualstudiomagazine.com/blogs/tool-tracker/2019/10/calling-methods-async.aspx
                //string fileName = BuildFileName(contentRoot, folderPath, se.Name);
                //Task task = Download(se.Source, fileName);
                //task.Wait();

                var httpClient = new HttpClient
                {
                    //BaseAddress = new Uri("https://raw.githubusercontent.com/OAI/OpenAPI-Specification/")
                };

                Task<Stream> task = httpClient.GetStreamAsync(se.Source);
                var stream = task.Result;

                //var stream = await httpClient.GetStreamAsync("master/examples/v3.0/petstore.yaml");
                // Read V3 as YAML
                var openApiDocument = new OpenApiStreamReader().Read(stream, out var diagnostic);

                combinedDoc.Merge(openApiDocument);
            }

            // sort paths
            var sPaths = combinedDoc.Paths.ToArray().OrderBy(x => x.Key).ToList();
            combinedDoc.Paths.Clear();
            foreach (var sPath in sPaths)
            {
                combinedDoc.Paths.Add(sPath.Key, sPath.Value);
            }

            combinedDoc.Components.Schemas = combinedDoc.Components.Schemas.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiSchema>();
            combinedDoc.Components.Responses = combinedDoc.Components.Responses.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiResponse>();
            combinedDoc.Components.Parameters = combinedDoc.Components.Parameters.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiParameter>();
            combinedDoc.Components.Examples = combinedDoc.Components.Examples.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiExample>();
            combinedDoc.Components.RequestBodies = combinedDoc.Components.RequestBodies.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiRequestBody>();
            combinedDoc.Components.Headers = combinedDoc.Components.Headers.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiHeader>();
            combinedDoc.Components.SecuritySchemes = combinedDoc.Components.SecuritySchemes.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiSecurityScheme>();
            combinedDoc.Components.Links = combinedDoc.Components.Links.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiLink>();
            combinedDoc.Components.Callbacks = combinedDoc.Components.Callbacks.ToArray().OrderBy(x => x.Key).ToDictionary<string, OpenApiCallback>();
            combinedDoc.Components.Extensions = combinedDoc.Components.Extensions.ToArray().OrderBy(x => x.Key).ToDictionary<string, IOpenApiExtension>();
            combinedDoc.Servers = combinedDoc.Servers.ToArray().OrderBy(x => x.Description).ToList();
            //combinedDoc.SecurityRequirements = combinedDoc.SecurityRequirements.ToArray().OrderBy(x => x.Key).ToDictionary<string, IOpenApiExtension>();
            combinedDoc.Tags = combinedDoc.Tags.ToArray().OrderBy(x => x.Description).ToList();

            //foreach (var v in mergetarget.ExternalDocs)
            //{
            //    target.ExternalDocs.Add(v);
            //}
            combinedDoc.Extensions = combinedDoc.Extensions.ToArray().OrderBy(x => x.Key).ToDictionary();

            var outputString = combinedDoc.Serialize(OpenApiSpecVersion.OpenApi3_0, OpenApiFormat.Json);

            string fileName = BuildFileName(contentRoot, folderPath, "combined");
            File.WriteAllText(fileName, outputString);

            string rel = Path.GetRelativePath(contentRoot, fileName);
            rel = rel.TrimStart('.');
            rel = rel.Replace('\\', '/');
            ////rel = "https://localhost:7233/" + rel;
            rel = "https://localhost:7253/apidoc/" + rel;

            //c.SwaggerEndpoint(rel, se.DisplayName);
            //c.SwaggerEndpoint($@"file:///{fileName}", se.DisplayName);
        }


        public static void SafeAdd<T, T2>(this IDictionary<T, T2> storage, KeyValuePair<T, T2> item)
        {
            if (storage.ContainsKey(item.Key))
            {
                return;
            }
            storage.Add(item);
        }
        public static void SafeAdd<T>(this IList<T> storage, T item)
        {
            if (storage.Contains(item))
            {
                return;
            }
            storage.Add(item);
        }

        public static void Merge(this OpenApiDocument target, OpenApiDocument mergeThis)
        {
            //target.ExternalDocs
            foreach (var v in mergeThis.Components.Callbacks)
            {
                target.Components.Callbacks.SafeAdd(v);
            }
            foreach (var v in mergeThis.Components.Examples)
            {
                target.Components.Examples.SafeAdd(v);
            }
            foreach (var v in mergeThis.Components.Extensions)
            {
                target.Components.Extensions.SafeAdd(v);
            }
            foreach (var v in mergeThis.Components.Headers)
            {
                target.Components.Headers.SafeAdd(v);
            }
            foreach (var v in mergeThis.Components.Links)
            {
                target.Components.Links.SafeAdd(v);
            }

            foreach (var v in mergeThis.Components.Parameters)
            {
                target.Components.Parameters.SafeAdd(v);
            }

            foreach (var v in mergeThis.Components.RequestBodies)
            {
                target.Components.RequestBodies.SafeAdd(v);
            }
            foreach (var v in mergeThis.Components.Responses)
            {
                target.Components.Responses.SafeAdd(v);
            }
            foreach (var v in mergeThis.Components.Schemas)
            {
                target.Components.Schemas.SafeAdd<string, OpenApiSchema>(v);
            }
            foreach (var v in mergeThis.Components.SecuritySchemes)
            {
                target.Components.SecuritySchemes.SafeAdd(v);
            }

            ///// <summary>
            ///// REQUIRED. Provides metadata about the API. The metadata MAY be used by tooling as required.
            ///// </summary>
            //public OpenApiInfo Info { get; set; }

            foreach (var v in mergeThis.Servers)
            {
                target.Servers.SafeAdd(v);
            }

            foreach (var v in mergeThis.Paths)
            {
                target.Paths.SafeAdd(v);
            }

            foreach (var v in mergeThis.SecurityRequirements)
            {
                target.SecurityRequirements.SafeAdd(v);
            }

            foreach (var v in mergeThis.Tags)
            {
                target.Tags.Add(v);
            }

            foreach (var v in mergeThis.Extensions)
            {
                target.Extensions.SafeAdd(v);
            }
        }
        public static string BuildFileName(string contentRoot, string folderPath, string entryName)
        {
            return Path.ChangeExtension(Path.GetFullPath(Path.Join(contentRoot, folderPath, entryName)), "json");
        }

        public class SwaggerEntry
        {
            public string Name { get; set; } = string.Empty;
            public string Source { get; set; } = string.Empty;
            public string DisplayName { get; set; } = string.Empty;
        }
    }
}
```
Edit appsettings.json
Before:
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```
After:
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "Swaggers": [
    {
      "Name": "Organizer",
      "Source": "https://localhost:7256/swagger/v1/swagger.json",
      "DisplayName": "Organizer"
    },
    {
      "Name": "CentralConfig",
      "Source": "https://localhost:7035/swagger/v1/swagger.json",
      "DisplayName": "Central Configuration"
    }
  ],
  "AllowedHosts": "*"
}
```
