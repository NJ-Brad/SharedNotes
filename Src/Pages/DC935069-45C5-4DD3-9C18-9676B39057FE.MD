# Add Web API Hosting to WinForms application
Bradford Bruce - March 19, 2024

## Introduction
This article will demonstrate a method to add a web server to a WinForms application.  It is intended to provide a REST API, as well as a WinForms application.  This could be useful if you desire to test utilizing Web APIs from your WinForms application

!!!>Note
This document replicates the default Web API functionality, generated by .Net
!!!

## Prerequisites
+ Visual Studio 2022

## Building the app

At a minimum, you will need this package
```bash
dotnet add package Microsoft.AspNetCore.App --version 8.0.3
```
If you would like to include Swagger support, you will need to add this package
```bash
dotnet add package Swashbuckle.AspNetCore --version 6.5.0
```

Create a class named ApiHost, then paste the code below
```csharp
// if you have installed the package Swashbuckle.AspNetCore, uncomment the line below to utilize it
//#define SwaggerInstalled

using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;


internal class ApiHost
{
    WebApplication app = null;

    internal async Task Run()
    {
        //var builder = WebApplication.CreateBuilder(args);
        var builder = WebApplication.CreateBuilder();

        if (string.IsNullOrEmpty(builder.Configuration["ASPNETCORE_URLS"]))
        {
            // if not previously set
            builder.WebHost.UseUrls("http://localhost:5010", "https://localhost:5011");
        }

        // Add services to the container.
        builder.Services.AddControllers();

        // https://www.thecodebuzz.com/failed-to-determine-the-https-port-for-the-redirect/
        //builder.Services.AddHttpsRedirection(options => { options.HttpsPort = 5001; });

        // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
        builder.Services.AddEndpointsApiExplorer();
#if SwaggerInstalled
            builder.Services.AddSwaggerGen();
#endif

        //var app = builder.Build();
        app = builder.Build();

        // Configure the HTTP request pipeline.
        if (app.Environment.IsDevelopment())
        {
#if SwaggerInstalled
                app.UseSwagger();
                app.UseSwaggerUI();
#endif
        }

        app.UseHttpsRedirection();

        app.UseAuthorization();

        app.MapControllers();

        app.RunAsync();
    }
}
```

If you wish to utilize Swagger, uncomment the second line, like this
```csharp hl_lines=”2”
// if you have installed the package Swashbuckle.AspNetCore, uncomment the line below to utilize it
#define SwaggerInstalled

using Microsoft.AspNetCore.Builder;
using Microsoft.AspNetCore.Hosting;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.Extensions.Hosting;
```

Create a folder called *Controllers* in the root of the project.
Inside the folder, create a class WeatherForecastController and copy the following code
```csharp
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Logging;

namespace TestHost.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class WeatherForecastController : ControllerBase
    {
        private static readonly string[] Summaries = new[]
        {
            "Freezing", "Bracing", "Chilly", "Cool", "Mild", "Warm", "Balmy", "Hot", "Sweltering", "Scorching"
        };

        private readonly ILogger<WeatherForecastController> _logger;

        public WeatherForecastController(ILogger<WeatherForecastController> logger)
        {
            _logger = logger;
        }

        [HttpGet(Name = "GetWeatherForecast")]
        public IEnumerable<WeatherForecast> Get()
        {
            return Enumerable.Range(1, 5).Select(index => new WeatherForecast
            {
                Date = DateOnly.FromDateTime(DateTime.Now.AddDays(index)),
                TemperatureC = Random.Shared.Next(-20, 55),
                Summary = Summaries[Random.Shared.Next(Summaries.Length)]
            })
            .ToArray();
        }
    }
}
```
Add the following class to the root of your project
```csharp
namespace TestHost
{
    public class WeatherForecast
    {
        public DateOnly Date { get; set; }

        public int TemperatureC { get; set; }

        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);

        public string? Summary { get; set; }
    }
}
```
Create a settings file AppSettings.json, in the root of your project
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```
In program.cs add the following, before calling Application.Run
```csharp
ApiHost host = new ApiHost();
host.Run();
```
Like this
```csharp  hl_lines=”15,16”
namespace TestHost
{
    internal static class Program
    {
        /// <summary>
        ///  The main entry point for the application.
        /// </summary>
        [STAThread]
        static void Main()
        {
            // To customize application configuration such as set high DPI settings or default font,
            // see https://aka.ms/applicationconfiguration.
            ApplicationConfiguration.Initialize();

            ApiHost host = new ApiHost();
            host.Run();
            Application.Run(new Form1());
        }
    }
}
```
## Demonstration
Compile and Start the application
You should see the application main form
### Testing the API
Open your browser and enter the address **https://localhost:7002/weatherforecast** then press enter
You should see a page like this
![Sample API result](<$LOCATION$>20240319-183437.jpg)


### If you selected to utilize Swagger
Open your browser and enter the address **https://localhost:7002/swagger** then press enter
You should see a page like this
![Sample Swagger UI](<$LOCATION$>20240319-183204.jpg)

## Conclusion
Hopefully this article will prove useful in your environment.

*Bradford Bruce has been solving problems, (and creating some), leveraging computers for over 30 years.  Everything from Pascal to C# has crossed his path.*

## Option 2
Add a WebAPI project to your existing solution
Add a class titled ApiHost to the WebAPI project
```csharp
using Microsoft.AspNetCore.Mvc.ApplicationParts;
using System.Reflection;

namespace WebApplication1
{
    public class ApiHost
    {
        WebApplication app = null;

        public List<string> endpoints { get; } = new List<string>();

        public async Task Run()
        {
            //var builder = WebApplication.CreateBuilder(args);
            var builder = WebApplication.CreateBuilder();

            if (string.IsNullOrEmpty(builder.Configuration["ASPNETCORE_URLS"]))
            {
                // if not previously set
                builder.WebHost.UseUrls("http://localhost:5010", "https://localhost:5011");
            }

            // Add services to the container.
            var assembly = this.GetType().Assembly;
            var part = new AssemblyPart(assembly);
            builder.Services.AddControllers()
                .ConfigureApplicationPartManager(apm => apm.ApplicationParts.Add(part));

            // Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
            builder.Services.AddEndpointsApiExplorer();
            builder.Services.AddSwaggerGen();

            //var app = builder.Build();
            // putting app in a class variable, instead of local, allows the API to continue after exiting this method
            app = builder.Build();

            // Configure the HTTP request pipeline.
            if (app.Environment.IsDevelopment())
            {
                app.UseSwagger();
                app.UseSwaggerUI();
            }

            app.UseHttpsRedirection();

            app.UseAuthorization();

            app.MapControllers();

            GetRoutes();

            app.RunAsync();
        }

        private void GetRoutes()
        {
            endpoints.Clear();

            endpoints.Add("Swagger");

            TypeInfo typeInfo = typeof(WebApplication).GetTypeInfo();
            var v1 = typeInfo.DeclaredFields.Where(e => e.Name == "_dataSources").FirstOrDefault();
            var v2 = (List<EndpointDataSource>)v1.GetValue(app);
            foreach (var v3 in v2)
            {
                foreach (var v4 in v3.Endpoints)
                {
                    var v5 = (Microsoft.AspNetCore.Routing.Patterns.RoutePattern)v4.GetType().GetProperty("RoutePattern").GetValue(v4, null);
                    endpoints.Add(v5.RawText);
                }
            }
        }
    }
}
```
Add a reference in your WinForms application to the WebAPI project
Add `using WebApplication1;` to the Program.cs file

In program.cs add the following, before calling Application.Run
```csharp
ApiHost host = new ApiHost();
host.Run();
```
Like this
```csharp  hl_lines=”15,16”
namespace TestHost
{
    internal static class Program
    {
        /// <summary>
        ///  The main entry point for the application.
        /// </summary>
        [STAThread]
        static void Main()
        {
            // To customize application configuration such as set high DPI settings or default font,
            // see https://aka.ms/applicationconfiguration.
            ApplicationConfiguration.Initialize();

            ApiHost host = new ApiHost();
            host.Run();
            Application.Run(new Form1());
        }
    }
}
```
