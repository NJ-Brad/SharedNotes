# Using API Key Security for Web API

Heavily inspired by : 
[Implementing Authentication in ASP.NET Core Web APIs | End Point Dev](https://www.endpointdev.com/blog/2022/06/implementing-authentication-in-asp.net-core-web-apis/ "Implementing Authentication in ASP.NET Core Web APIs | End Point Dev")
and
[Add an authorization header to your swagger-ui with Swashbuckle (revisited) | Matt&#039;s work blog](https://mattfrear.com/2018/07/21/add-an-authorization-header-to-your-swagger-ui-with-swashbuckle-revisited/ "Add an authorization header to your swagger-ui with Swashbuckle (revisited) | Matt&#039;s work blog")


Install package
Swashbuckle.AspNetCore.Filters

## Program.CS

### Before
```csharp
var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

app.UseAuthorization();

app.MapControllers();

app.Run();
```

### Steps
Between AddEndpointsApiExplorer(); and AddSwaggerGen();

insert
```csharp
builder.Services.AddAuthentication("ApiKey")
    .AddScheme<AuthenticationSchemeOptions, ApiKeyAuthenticationHandler>(
            "ApiKey",
            options => { }
        );

builder.Services.AddAuthorization();
```

Replace AddSwaggerGen() with
```csharp
// this has to be AFTER AddAuthorization()
builder.Services.AddSwaggerGen(options =>
{
    options.AddSecurityDefinition("oauth2", new OpenApiSecurityScheme
    {
        Description = "Standard Authorization header using the Bearer scheme. Example: \"bearer {token}\"",
        In = ParameterLocation.Header,
        Name = ApiKeyAuthenticationHandler.HeaderName,
        Type = SecuritySchemeType.ApiKey
    });
    options.OperationFilter<SecurityRequirementsOperationFilter>();
});
```
Add
```csharp
app.UseAuthentication();
```
immediately before 
```csharp
app.UseAuthorization();
```

Move
```csharp
app.UseHttpsRedirection();
```
to immediately before
```csharp
app.MapControllers();
```

## After
```csharp
using ApiKeyDemo;
using Microsoft.AspNetCore.Authentication;
using Microsoft.OpenApi.Models;
using Swashbuckle.AspNetCore.Filters;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container.

builder.Services.AddControllers();
// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();

builder.Services.AddAuthentication("ApiKey")
    .AddScheme<AuthenticationSchemeOptions, ApiKeyAuthenticationHandler>(
            "ApiKey",
            options => { }
        );

builder.Services.AddAuthorization();

// this has to be AFTER AddAuthorization()
builder.Services.AddSwaggerGen(options =>
{
    options.AddSecurityDefinition("oauth2", new OpenApiSecurityScheme
    {
        Description = "Standard Authorization header using the Bearer scheme. Example: \"bearer {token}\"",
        In = ParameterLocation.Header,
        Name = ApiKeyAuthenticationHandler.HeaderName,
        Type = SecuritySchemeType.ApiKey
    });
    options.OperationFilter<SecurityRequirementsOperationFilter>();
});

var app = builder.Build();

// Configure the HTTP request pipeline.
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseAuthentication();
app.UseAuthorization();

app.UseHttpsRedirection();

app.MapControllers();

app.Run();
```

## Add new class ApiKeyAuthenticationHandler
```csharp
using Microsoft.AspNetCore.Authentication;
using Microsoft.AspNetCore.Identity;
using Microsoft.Extensions.Options;
using System.Security.Claims;
using System.Text.Encodings.Web;

namespace ApiKeyDemo
{
    // https://www.endpointdev.com/blog/2022/06/implementing-authentication-in-asp.net-core-web-apis/
    class ApiKeyAuthenticationHandler : AuthenticationHandler<AuthenticationSchemeOptions>
    {
        public static string HeaderName { get { return "Api-Key"; } }

        public ApiKeyAuthenticationHandler(
            IOptionsMonitor<AuthenticationSchemeOptions> options,
            ILoggerFactory logger,
            UrlEncoder encoder,
            ISystemClock clock
        ) : base(options, logger, encoder, clock)
        {
        }

        protected override async Task<AuthenticateResult> HandleAuthenticateAsync()
        {
            if (!Request.Headers.ContainsKey(HeaderName))
            {
                return AuthenticateResult.Fail("Header Not Found.");
            }

            string apiKeyToValidate = Request.Headers[HeaderName];

            if (string.IsNullOrEmpty(apiKeyToValidate))
            {
                return AuthenticateResult.Fail("Invalid key.");
            }

            // look up apiKey from database
            //var apiKey = await _context.UserApiKeys
            //    .Include(uak => uak.User)
            //    .SingleOrDefaultAsync(uak => uak.Value == apiKeyToValidate);

            //if (apikey == null)
            //{
            //    return AuthenticateResult.fail("invalid key.");
            //}

            if (apiKeyToValidate != "Dummy_Key")
            {
                return AuthenticateResult.Fail("Invalid Key.");
            }


            //return AuthenticateResult.Success(CreateTicket(apiKey.User));
            IdentityUser user = new IdentityUser("Brad") { Email = "" };

            return AuthenticateResult.Success(CreateTicket(user));
        }

        private AuthenticationTicket CreateTicket(IdentityUser user)
        {
            var claims = new[] {
                new Claim(ClaimTypes.NameIdentifier, user.Id),
                new Claim(ClaimTypes.Name, user.UserName),
                new Claim(ClaimTypes.Email, user.Email)
            };

            var identity = new ClaimsIdentity(claims, Scheme.Name);
            var principal = new ClaimsPrincipal(identity);
            var ticket = new AuthenticationTicket(principal, Scheme.Name);

            return ticket;
        }
    }
}
```
## Controllers
In each controller that you want to secure, add an Authorize attribute
```csharp
[Authorize]
```

